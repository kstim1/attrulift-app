<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attrulift ‚Äî Marketing Attribution for SMBs</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Sora:wght@300;400;500;600;700&display=swap');

  :root {
    --bg: #0d0f14;
    --surface: #13161d;
    --surface2: #1a1e28;
    --surface3: #222738;
    --border: #2a2f3f;
    --border2: #343b52;
    --text: #e8eaf0;
    --text2: #8b93a8;
    --text3: #555e75;
    --accent: #4f7cff;
    --accent2: #3a5cd4;
    --green: #34c78a;
    --amber: #f5a623;
    --red: #f05c5c;
    --purple: #9b6dff;
    --teal: #2dd4bf;
    --mono: 'DM Mono', monospace;
    --sans: 'Sora', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 14px;
    line-height: 1.5;
  }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  .app { display: flex; height: 100vh; overflow: hidden; }

  .sidebar {
    width: 220px;
    flex-shrink: 0;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 0;
  }

  .logo {
    padding: 20px 20px 16px;
    border-bottom: 1px solid var(--border);
    font-weight: 700;
    font-size: 18px;
    letter-spacing: -0.5px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .logo-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 12px var(--accent); }
  .logo svg { flex-shrink: 0; }

  .nav { padding: 12px 10px; flex: 1; }
  .nav-section { font-size: 10px; font-weight: 600; letter-spacing: 1.5px; color: var(--text3); text-transform: uppercase; padding: 8px 10px 4px; }
  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 10px; border-radius: 6px; cursor: pointer;
    color: var(--text2); font-size: 13px; font-weight: 400;
    transition: all 0.15s; margin-bottom: 1px;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: rgba(79,124,255,0.12); color: var(--accent); font-weight: 500; }
  .nav-icon { font-size: 15px; width: 18px; text-align: center; }

  .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  .topbar {
    height: 56px; flex-shrink: 0;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px;
  }
  .topbar-title { font-size: 15px; font-weight: 600; }
  .topbar-actions { display: flex; gap: 8px; align-items: center; }

  .btn {
    padding: 7px 14px; border-radius: 6px; border: none; cursor: pointer;
    font-family: var(--sans); font-size: 13px; font-weight: 500;
    transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: var(--accent2); }
  .btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border2); }
  .btn-ghost:hover { background: var(--surface2); color: var(--text); }
  .btn-sm { padding: 5px 10px; font-size: 12px; }

  .content { flex: 1; overflow-y: auto; padding: 24px; }

  /* ‚îÄ‚îÄ Pages ‚îÄ‚îÄ */
  .page { display: none; }
  .page.active { display: block; }

  /* ‚îÄ‚îÄ Upload Page ‚îÄ‚îÄ */
  .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }

  .upload-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 24px;
  }
  .upload-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
  .upload-card p { font-size: 12px; color: var(--text2); margin-bottom: 16px; }

  .drop-zone {
    border: 1.5px dashed var(--border2); border-radius: 8px;
    padding: 32px 20px; text-align: center; cursor: pointer;
    transition: all 0.2s; background: var(--surface2);
  }
  .drop-zone:hover, .drop-zone.dragover {
    border-color: var(--accent); background: rgba(79,124,255,0.05);
  }
  .drop-zone .dz-icon { font-size: 28px; margin-bottom: 8px; }
  .drop-zone .dz-label { font-size: 13px; color: var(--text2); }
  .drop-zone .dz-sub { font-size: 11px; color: var(--text3); margin-top: 4px; }
  .drop-zone input { display: none; }

  .file-loaded {
    display: flex; align-items: center; gap: 10px;
    background: rgba(52,199,138,0.08); border: 1px solid rgba(52,199,138,0.2);
    border-radius: 8px; padding: 12px 14px; margin-top: 12px;
  }
  .file-loaded .fl-name { font-size: 13px; font-weight: 500; color: var(--green); }
  .file-loaded .fl-meta { font-size: 11px; color: var(--text3); }

  .schema-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  .schema-table th { font-size: 10px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--text3); padding: 6px 10px; text-align: left; border-bottom: 1px solid var(--border); }
  .schema-table td { padding: 8px 10px; font-size: 12px; border-bottom: 1px solid var(--border); }
  .schema-table td:first-child { font-family: var(--mono); font-size: 11px; color: var(--accent); }
  .badge { display: inline-flex; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; letter-spacing: 0.5px; }
  .badge-req { background: rgba(79,124,255,0.15); color: var(--accent); }
  .badge-opt { background: rgba(139,147,168,0.12); color: var(--text3); }

  .config-section { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
  .config-section h3 { font-size: 13px; font-weight: 600; margin-bottom: 14px; }

  .config-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .config-row label { font-size: 13px; color: var(--text2); }
  .config-row select, .config-row input[type=number] {
    background: var(--surface2); border: 1px solid var(--border2); color: var(--text);
    border-radius: 6px; padding: 6px 10px; font-family: var(--sans); font-size: 13px;
    outline: none; min-width: 160px;
  }
  .config-row select:focus, .config-row input[type=number]:focus { border-color: var(--accent); }

  .model-cards { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; }
  .model-card {
    border: 1.5px solid var(--border); border-radius: 8px; padding: 12px;
    cursor: pointer; transition: all 0.15s;
  }
  .model-card:hover { border-color: var(--border2); }
  .model-card.selected { border-color: var(--accent); background: rgba(79,124,255,0.06); }
  .model-card .mc-name { font-size: 12px; font-weight: 600; margin-bottom: 4px; }
  .model-card .mc-desc { font-size: 11px; color: var(--text3); line-height: 1.4; }

  .run-bar {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px 20px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .run-bar-info { font-size: 12px; color: var(--text2); }
  .run-bar-info strong { color: var(--text); }

  /* ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ */
  .kpi-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 24px; }
  .kpi-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px;
  }
  .kpi-card .kpi-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }
  .kpi-card .kpi-value { font-size: 24px; font-weight: 600; letter-spacing: -0.5px; }
  .kpi-card .kpi-sub { font-size: 11px; color: var(--text3); margin-top: 4px; }
  .kpi-card .kpi-delta { font-size: 11px; margin-top: 6px; }
  .delta-up { color: var(--green); }
  .delta-down { color: var(--red); }

  .tab-bar { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
  .tab-btn {
    padding: 10px 18px; font-size: 13px; font-weight: 500; cursor: pointer;
    color: var(--text3); border-bottom: 2px solid transparent; margin-bottom: -1px;
    transition: all 0.15s; background: none; border-top: none; border-left: none; border-right: none;
    font-family: var(--sans);
  }
  .tab-btn:hover { color: var(--text2); }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  .chart-row { display: grid; grid-template-columns: 2fr 1fr; gap: 18px; margin-bottom: 18px; }
  .chart-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px;
  }
  .chart-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
  .chart-card .chart-sub { font-size: 11px; color: var(--text3); margin-bottom: 16px; }
  .chart-wrap { position: relative; }

  .channel-table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  .channel-table { width: 100%; border-collapse: collapse; }
  .channel-table th {
    font-size: 10px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase;
    color: var(--text3); padding: 12px 16px; text-align: left;
    border-bottom: 1px solid var(--border); background: var(--surface2);
  }
  .channel-table th.num { text-align: right; }
  .channel-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 13px; }
  .channel-table td.num { text-align: right; font-family: var(--mono); font-size: 12px; }
  .channel-table tr:last-child td { border-bottom: none; }
  .channel-table tr:hover td { background: var(--surface2); }

  .channel-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; vertical-align: middle; }
  .confidence-bar { display: flex; align-items: center; gap: 8px; }
  .conf-track { flex: 1; height: 4px; background: var(--surface3); border-radius: 2px; overflow: hidden; }
  .conf-fill { height: 100%; border-radius: 2px; }

  /* ‚îÄ‚îÄ Account view ‚îÄ‚îÄ */
  .account-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-bottom: 18px; }
  .account-table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }

  /* ‚îÄ‚îÄ Explore ‚îÄ‚îÄ */
  .explore-layout { display: grid; grid-template-columns: 260px 1fr; gap: 18px; }
  .explore-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
  .explore-panel h4 { font-size: 12px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text3); margin-bottom: 12px; }

  .field-list { display: flex; flex-direction: column; gap: 4px; margin-bottom: 20px; }
  .field-pill {
    display: flex; align-items: center; gap: 8px;
    padding: 7px 10px; border-radius: 6px; font-size: 12px;
    background: var(--surface2); cursor: grab; border: 1px solid var(--border);
    color: var(--text2); transition: all 0.15s;
  }
  .field-pill:hover { border-color: var(--border2); color: var(--text); }
  .field-pill .fp-type { font-size: 9px; font-family: var(--mono); color: var(--text3); margin-left: auto; }

  .axis-drop {
    border: 1.5px dashed var(--border2); border-radius: 6px; padding: 10px 12px;
    margin-bottom: 10px; min-height: 40px; font-size: 12px; color: var(--text3);
    display: flex; align-items: center; gap: 8px; transition: all 0.15s;
  }
  .axis-drop.has-value { border-color: var(--accent); color: var(--text); background: rgba(79,124,255,0.05); }
  .axis-drop:hover { border-color: var(--border2); background: var(--surface2); }

  .explore-config { margin-bottom: 14px; }
  .explore-config label { font-size: 11px; color: var(--text3); display: block; margin-bottom: 4px; }
  .explore-config select {
    width: 100%; background: var(--surface2); border: 1px solid var(--border2); color: var(--text);
    border-radius: 6px; padding: 7px 10px; font-family: var(--sans); font-size: 12px; outline: none;
  }

  .explore-chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; }

  /* ‚îÄ‚îÄ Match quality ‚îÄ‚îÄ */
  .match-stat { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
  .match-stat:last-child { border-bottom: none; }
  .match-label { font-size: 12px; color: var(--text2); flex: 1; }
  .match-value { font-family: var(--mono); font-size: 13px; font-weight: 500; }

  /* ‚îÄ‚îÄ Empty / loading states ‚îÄ‚îÄ */
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text3); }
  .empty-state .es-icon { font-size: 36px; margin-bottom: 12px; }
  .empty-state .es-msg { font-size: 14px; color: var(--text2); margin-bottom: 6px; }
  .empty-state .es-sub { font-size: 12px; }

  .tag { display: inline-flex; padding: 2px 7px; border-radius: 4px; font-size: 10px; font-weight: 600; }
  .tag-green { background: rgba(52,199,138,0.12); color: var(--green); }
  .tag-amber { background: rgba(245,166,35,0.12); color: var(--amber); }
  .tag-blue { background: rgba(79,124,255,0.12); color: var(--accent); }
  .tag-purple { background: rgba(155,109,255,0.12); color: var(--purple); }

  .alert-box {
    border-radius: 8px; padding: 12px 14px; margin-bottom: 16px;
    font-size: 12px; display: flex; align-items: flex-start; gap: 10px;
  }
  .alert-info { background: rgba(79,124,255,0.08); border: 1px solid rgba(79,124,255,0.2); color: var(--text2); }
  .alert-success { background: rgba(52,199,138,0.08); border: 1px solid rgba(52,199,138,0.2); color: var(--green); }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
</style>
</head>
<body>
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Lift arrow base -->
        <rect x="2" y="18" width="4" height="6" rx="1" fill="#4f7cff" opacity="0.5"/>
        <rect x="8" y="13" width="4" height="11" rx="1" fill="#4f7cff" opacity="0.7"/>
        <rect x="14" y="8" width="4" height="16" rx="1" fill="#4f7cff" opacity="0.9"/>
        <!-- Rising arrow -->
        <path d="M21 10 L21 4 L24 4" stroke="#34c78a" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        <path d="M17.5 6.5 L21 3.5 L24.5 6.5" stroke="#34c78a" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      </svg>
      <span style="letter-spacing:-0.5px;">Attru<span style="color:var(--accent);">lift</span></span>
    </div>
    <nav class="nav">
      <div class="nav-section">Workspace</div>
      <div class="nav-item active" onclick="showPage('upload')">
        <span class="nav-icon">‚¨Ü</span> Data Upload
      </div>
      <div class="nav-item" onclick="showPage('dashboard')">
        <span class="nav-icon">‚óà</span> Attribution
      </div>
      <div class="nav-item" onclick="showPage('explore')">
        <span class="nav-icon">‚äû</span> Dashboard
      </div>
      <div class="nav-section" style="margin-top:12px;">Settings</div>
      <div class="nav-item" onclick="showPage('config')">
        <span class="nav-icon">‚öô</span> Configuration
      </div>
    </nav>
    <div style="padding:14px;border-top:1px solid var(--border);">
      <div style="font-size:11px;color:var(--text3);margin-bottom:6px;">Match Quality</div>
      <div id="sidebar-match" style="font-size:13px;color:var(--text2);">No data loaded</div>
    </div>
  </aside>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <div class="topbar-title" id="page-title">Data Upload</div>
      <div class="topbar-actions">
        <span id="model-badge" style="font-size:11px;color:var(--text3);font-family:var(--mono);">MODEL: LINEAR</span>
        <button class="btn btn-ghost btn-sm" onclick="loadSampleData()">Load Sample Data</button>
        <button class="btn btn-primary btn-sm" onclick="runAttribution()" id="run-btn" disabled>Run Attribution</button>
      </div>
    </div>

    <div class="content">

      <!-- ‚îÄ‚îÄ UPLOAD PAGE ‚îÄ‚îÄ -->
      <div class="page active" id="page-upload">
        <div class="upload-grid">

          <!-- Conversions -->
          <div class="upload-card">
            <h3>Conversion / Transaction Data</h3>
            <p>Upload your CRM exports, ecomm transactions, lead form fills, or opportunity data.</p>
            <div class="drop-zone" id="conv-drop" onclick="document.getElementById('conv-file').click()" ondragover="handleDrag(event,'conv-drop')" ondragleave="handleDragLeave(event,'conv-drop')" ondrop="handleDrop(event,'conv')">
              <div class="dz-icon">üìã</div>
              <div class="dz-label">Drop CSV here or click to browse</div>
              <div class="dz-sub">Max 50MB ¬∑ CSV only</div>
              <input type="file" id="conv-file" accept=".csv" onchange="handleFile(event,'conv')">
            </div>
            <div id="conv-loaded" style="display:none;"></div>

            <table class="schema-table" style="margin-top:16px;">
              <thead><tr><th>Field</th><th>Type</th><th>Required</th></tr></thead>
              <tbody>
                <tr><td>timestamp</td><td style="color:var(--text2);">datetime</td><td><span class="badge badge-req">Required</span></td></tr>
                <tr><td>conversion_value</td><td style="color:var(--text2);">number</td><td><span class="badge badge-req">Required</span></td></tr>
                <tr><td>conversion_type</td><td style="color:var(--text2);">string</td><td><span class="badge badge-req">Required</span></td></tr>
                <tr><td>company_name</td><td style="color:var(--text2);">string</td><td><span class="badge badge-opt">Optional</span></td></tr>
                <tr><td>geo</td><td style="color:var(--text2);">string</td><td><span class="badge badge-opt">Optional</span></td></tr>
                <tr><td>click_id</td><td style="color:var(--text2);">string</td><td><span class="badge badge-opt">Optional</span></td></tr>
              </tbody>
            </table>
          </div>

          <!-- Exposure -->
          <div class="upload-card">
            <h3>Ad Exposure / Impression Data</h3>
            <p>Export from LinkedIn Campaign Manager, Google Ads, Meta Ads Manager, etc.</p>
            <div class="drop-zone" id="exp-drop" onclick="document.getElementById('exp-file').click()" ondragover="handleDrag(event,'exp-drop')" ondragleave="handleDragLeave(event,'exp-drop')" ondrop="handleDrop(event,'exp')">
              <div class="dz-icon">üì°</div>
              <div class="dz-label">Drop CSV here or click to browse</div>
              <div class="dz-sub">Max 50MB ¬∑ CSV only</div>
              <input type="file" id="exp-file" accept=".csv" onchange="handleFile(event,'exp')">
            </div>
            <div id="exp-loaded" style="display:none;"></div>

            <table class="schema-table" style="margin-top:16px;">
              <thead><tr><th>Field</th><th>Type</th><th>Required</th></tr></thead>
              <tbody>
                <tr><td>timestamp</td><td style="color:var(--text2);">datetime</td><td><span class="badge badge-req">Required</span></td></tr>
                <tr><td>channel</td><td style="color:var(--text2);">string</td><td><span class="badge badge-req">Required</span></td></tr>
                <tr><td>campaign</td><td style="color:var(--text2);">string</td><td><span class="badge badge-opt">Optional</span></td></tr>
                <tr><td>company_name</td><td style="color:var(--text2);">string</td><td><span class="badge badge-opt">Optional</span></td></tr>
                <tr><td>geo</td><td style="color:var(--text2);">string</td><td><span class="badge badge-opt">Optional</span></td></tr>
                <tr><td>click_id</td><td style="color:var(--text2);">string</td><td><span class="badge badge-opt">Optional</span></td></tr>
                <tr><td>impressions</td><td style="color:var(--text2);">number</td><td><span class="badge badge-opt">Optional</span></td></tr>
                <tr><td>spend</td><td style="color:var(--text2);">number</td><td><span class="badge badge-opt">Optional</span></td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Attribution Config -->
        <div class="config-section">
          <h3>Attribution Model</h3>
          <div class="model-cards">
            <div class="model-card" onclick="selectModel('last-touch',this)">
              <div class="mc-name">Last Touch</div>
              <div class="mc-desc">100% credit to final touchpoint before conversion</div>
            </div>
            <div class="model-card" onclick="selectModel('first-touch',this)">
              <div class="mc-name">First Touch</div>
              <div class="mc-desc">100% credit to first touchpoint in the journey</div>
            </div>
            <div class="model-card selected" onclick="selectModel('linear',this)">
              <div class="mc-name">Linear</div>
              <div class="mc-desc">Equal credit distributed across all touchpoints</div>
            </div>
            <div class="model-card" onclick="selectModel('time-decay',this)">
              <div class="mc-name">Time Decay</div>
              <div class="mc-desc">More credit to touchpoints closer to conversion</div>
            </div>
          </div>
        </div>

        <!-- Matching Config -->
        <div class="config-section">
          <h3>Identity Resolution Config</h3>
          <div class="config-row">
            <label>Matching Priority</label>
            <span style="font-size:12px;color:var(--text3);">Click ID ‚Üí Company Name ‚Üí Geo + Time Window</span>
          </div>
          <div class="config-row">
            <label>Time Window (days)</label>
            <input type="number" id="time-window" value="30" min="1" max="90" style="width:90px;">
          </div>
          <div class="config-row">
            <label>Min Confidence Threshold</label>
            <select id="conf-threshold">
              <option value="0.3">Low (include geo-only matches)</option>
              <option value="0.6" selected>Medium (company + time window)</option>
              <option value="0.85">High (click ID or company + geo)</option>
            </select>
          </div>
        </div>

        <div class="run-bar">
          <div class="run-bar-info" id="run-bar-status">Load conversion and exposure data to begin, or click <strong>Load Sample Data</strong> to explore.</div>
          <button class="btn btn-primary" onclick="runAttribution()" id="run-btn2" disabled>Run Attribution ‚Üí</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ DASHBOARD PAGE ‚îÄ‚îÄ -->
      <div class="page" id="page-dashboard">
        <div class="kpi-row" id="kpi-row">
          <div class="kpi-card">
            <div class="kpi-label">Attributed Conversions</div>
            <div class="kpi-value" id="kpi-conv">‚Äî</div>
            <div class="kpi-sub" id="kpi-match-rate">‚Äî</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Attributed Revenue</div>
            <div class="kpi-value" id="kpi-rev">‚Äî</div>
            <div class="kpi-sub">Conversion value sum</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Top Channel</div>
            <div class="kpi-value" id="kpi-top-channel" style="font-size:16px;">‚Äî</div>
            <div class="kpi-sub" id="kpi-top-pct">‚Äî</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Avg. Touchpoints</div>
            <div class="kpi-value" id="kpi-touches">‚Äî</div>
            <div class="kpi-sub">Per conversion path</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Total Ad Spend</div>
            <div class="kpi-value" id="kpi-spend">‚Äî</div>
            <div class="kpi-sub" id="kpi-roas">‚Äî</div>
          </div>
        </div>

        <div class="tab-bar">
          <button class="tab-btn active" onclick="switchTab('channel')">Channel View</button>
          <button class="tab-btn" onclick="switchTab('account')">Account View</button>
          <button class="tab-btn" onclick="switchTab('quality')">Match Quality</button>
        </div>

        <!-- Channel Tab -->
        <div class="tab-content active" id="tab-channel">
          <div class="chart-row">
            <div class="chart-card">
              <h4>Attributed Conversions by Channel</h4>
              <div class="chart-sub">Distributed using <span id="model-label">Linear</span> model ¬∑ <span id="window-label">30</span>-day attribution window</div>
              <div class="chart-wrap" style="height:260px;">
                <canvas id="channel-bar-chart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h4>Revenue Share</h4>
              <div class="chart-sub">By attributed channel</div>
              <div class="chart-wrap" style="height:260px;">
                <canvas id="channel-pie-chart"></canvas>
              </div>
            </div>
          </div>

          <div class="chart-card" style="margin-bottom:18px;">
            <h4>Conversion Trend</h4>
            <div class="chart-sub">Attributed conversions over time by channel</div>
            <div class="chart-wrap" style="height:200px;">
              <canvas id="trend-chart"></canvas>
            </div>
          </div>

          <div class="channel-table-wrap">
            <table class="channel-table">
              <thead>
                <tr>
                  <th>Channel</th>
                  <th>Campaigns</th>
                  <th class="num">Attributed Conv.</th>
                  <th class="num">Attributed Revenue</th>
                  <th class="num">Spend</th>
                  <th class="num">ROAS</th>
                  <th>Confidence</th>
                </tr>
              </thead>
              <tbody id="channel-table-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Account Tab -->
        <div class="tab-content" id="tab-account">
          <div class="alert-box alert-info">
            ‚ÑπÔ∏è Account-level view shows company-matched conversions only. Unmatched or geo-only records are excluded from this view.
          </div>
          <div class="account-table-wrap">
            <table class="channel-table">
              <thead>
                <tr>
                  <th>Company</th>
                  <th>Geo</th>
                  <th>Conversion Type</th>
                  <th class="num">Value</th>
                  <th>Matched Channel</th>
                  <th>Match Method</th>
                  <th>Confidence</th>
                </tr>
              </thead>
              <tbody id="account-table-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Match Quality Tab -->
        <div class="tab-content" id="tab-quality">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;">
            <div class="chart-card">
              <h4>Match Method Breakdown</h4>
              <div class="chart-sub">How conversions were attributed</div>
              <div style="height:220px;"><canvas id="match-method-chart"></canvas></div>
            </div>
            <div class="chart-card">
              <h4>Match Quality Summary</h4>
              <div class="chart-sub">Coverage and confidence metrics</div>
              <div id="match-stats"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ EXPLORE PAGE ‚îÄ‚îÄ -->
      <div class="page" id="page-explore">
        <div class="explore-layout">
          <div>
            <div class="explore-panel" style="margin-bottom:14px;">
              <h4>Dimensions</h4>
              <div class="field-list" id="dim-list">
                <div class="field-pill" draggable="true" data-field="channel" data-type="dim" ondragstart="dragStart(event)">
                  <span>üè∑</span> Channel <span class="fp-type">DIM</span>
                </div>
                <div class="field-pill" draggable="true" data-field="campaign" data-type="dim" ondragstart="dragStart(event)">
                  <span>üì¢</span> Campaign <span class="fp-type">DIM</span>
                </div>
                <div class="field-pill" draggable="true" data-field="conversion_type" data-type="dim" ondragstart="dragStart(event)">
                  <span>üéØ</span> Conversion Type <span class="fp-type">DIM</span>
                </div>
                <div class="field-pill" draggable="true" data-field="geo" data-type="dim" ondragstart="dragStart(event)">
                  <span>üìç</span> Geo <span class="fp-type">DIM</span>
                </div>
                <div class="field-pill" draggable="true" data-field="company" data-type="dim" ondragstart="dragStart(event)">
                  <span>üè¢</span> Company <span class="fp-type">DIM</span>
                </div>
                <div class="field-pill" draggable="true" data-field="match_method" data-type="dim" ondragstart="dragStart(event)">
                  <span>üîó</span> Match Method <span class="fp-type">DIM</span>
                </div>
              </div>

              <h4 style="margin-top:4px;">Metrics</h4>
              <div class="field-list">
                <div class="field-pill" draggable="true" data-field="attributed_conversions" data-type="metric" ondragstart="dragStart(event)">
                  <span>‚óé</span> Attributed Conv. <span class="fp-type">MET</span>
                </div>
                <div class="field-pill" draggable="true" data-field="attributed_revenue" data-type="metric" ondragstart="dragStart(event)">
                  <span>$</span> Attributed Rev. <span class="fp-type">MET</span>
                </div>
                <div class="field-pill" draggable="true" data-field="spend" data-type="metric" ondragstart="dragStart(event)">
                  <span>üí∏</span> Ad Spend <span class="fp-type">MET</span>
                </div>
                <div class="field-pill" draggable="true" data-field="roas" data-type="metric" ondragstart="dragStart(event)">
                  <span>‚ö°</span> ROAS <span class="fp-type">MET</span>
                </div>
              </div>
            </div>

            <div class="explore-panel">
              <h4>Chart Config</h4>
              <div class="explore-config">
                <label>X AXIS / GROUP BY</label>
                <div class="axis-drop" id="x-drop" ondragover="allowDrop(event)" ondrop="dropAxis(event,'x')">
                  <span id="x-drop-label" style="color:var(--text3);">Drop dimension here</span>
                </div>
              </div>
              <div class="explore-config">
                <label>Y AXIS / METRIC</label>
                <div class="axis-drop" id="y-drop" ondragover="allowDrop(event)" ondrop="dropAxis(event,'y')">
                  <span id="y-drop-label" style="color:var(--text3);">Drop metric here</span>
                </div>
              </div>
              <div class="explore-config">
                <label>CHART TYPE</label>
                <select id="chart-type" onchange="renderExploreChart()">
                  <option value="bar">Bar Chart</option>
                  <option value="line">Line Chart</option>
                  <option value="doughnut">Donut Chart</option>
                </select>
              </div>
              <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:8px;" onclick="renderExploreChart()">Update Chart</button>
            </div>
          </div>

          <div class="explore-chart-card">
            <div id="explore-empty" class="empty-state">
              <div class="es-icon">‚äû</div>
              <div class="es-msg">Drop a dimension and metric to build a chart</div>
              <div class="es-sub">Drag fields from the left panel onto the X and Y axes</div>
            </div>
            <div id="explore-chart-wrap" style="display:none;">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
                <div>
                  <h4 id="explore-chart-title" style="font-size:14px;"></h4>
                  <div style="font-size:11px;color:var(--text3);margin-top:2px;" id="explore-chart-sub"></div>
                </div>
              </div>
              <div style="height:380px;"><canvas id="explore-canvas"></canvas></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ CONFIG PAGE ‚îÄ‚îÄ -->
      <div class="page" id="page-config">
        <div class="config-section" style="max-width:600px;">
          <h3>Attribution Settings</h3>
          <div class="config-row">
            <label>Default Attribution Model</label>
            <select>
              <option>Linear</option>
              <option>Last Touch</option>
              <option>First Touch</option>
              <option>Time Decay</option>
            </select>
          </div>
          <div class="config-row">
            <label>Attribution Window</label>
            <select>
              <option>7 days</option>
              <option selected>30 days</option>
              <option>60 days</option>
              <option>90 days</option>
            </select>
          </div>
          <div class="config-row">
            <label>Time Decay Half-Life</label>
            <select>
              <option>3 days</option>
              <option selected>7 days</option>
              <option>14 days</option>
            </select>
          </div>
        </div>
        <div class="config-section" style="max-width:600px;">
          <h3>Identity Resolution</h3>
          <div class="config-row">
            <label>Company Name Fuzzy Match</label>
            <select>
              <option>Exact match only</option>
              <option selected>Fuzzy (80% similarity)</option>
              <option>Fuzzy (60% similarity)</option>
            </select>
          </div>
          <div class="config-row">
            <label>Geo Match Level</label>
            <select>
              <option>City</option>
              <option selected>State / Region</option>
              <option>Country</option>
            </select>
          </div>
          <div class="config-row">
            <label>Min Confidence to Include</label>
            <select>
              <option>0.3 ‚Äî Include all</option>
              <option selected>0.6 ‚Äî Medium confidence+</option>
              <option>0.85 ‚Äî High confidence only</option>
            </select>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = {
  convData: null,
  expData: null,
  results: null,
  model: 'linear',
  timeWindow: 30,
  confThreshold: 0.6,
};

let charts = {};
let draggedField = null;
let exploreX = null, exploreY = null;

// ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  const navMap = { upload: 0, dashboard: 1, explore: 2, config: 3 };
  document.querySelectorAll('.nav-item')[navMap[name]].classList.add('active');
  const titles = { upload: 'Data Upload', dashboard: 'Attribution Dashboard', explore: 'Dashboard', config: 'Configuration' };
  document.getElementById('page-title').textContent = titles[name];
}

function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  event.target.classList.add('active');
}

function selectModel(model, el) {
  state.model = model;
  document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  const labels = { 'last-touch': 'LAST-TOUCH', 'first-touch': 'FIRST-TOUCH', 'linear': 'LINEAR', 'time-decay': 'TIME-DECAY' };
  document.getElementById('model-badge').textContent = 'MODEL: ' + labels[model];
}

// ‚îÄ‚îÄ‚îÄ File Handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleDrag(e, id) { e.preventDefault(); document.getElementById(id).classList.add('dragover'); }
function handleDragLeave(e, id) { document.getElementById(id).classList.remove('dragover'); }
function handleDrop(e, type) {
  e.preventDefault();
  const id = type + '-drop';
  document.getElementById(id).classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) processFile(file, type);
}
function handleFile(e, type) {
  const file = e.target.files[0];
  if (file) processFile(file, type);
}

function processFile(file, type) {
  const reader = new FileReader();
  reader.onload = function(e) {
    const rows = parseCSV(e.target.result);
    if (type === 'conv') state.convData = rows;
    else state.expData = rows;
    showFileLoaded(type, file.name, rows.length);
    checkRunReady();
  };
  reader.readAsText(file);
}

function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/[^a-z0-9_]/g, '_'));
  return lines.slice(1).filter(l => l.trim()).map(line => {
    const vals = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
    const obj = {};
    headers.forEach((h, i) => obj[h] = vals[i] || '');
    return obj;
  });
}

function showFileLoaded(type, name, rows) {
  const el = document.getElementById(type + '-loaded');
  el.style.display = 'flex';
  el.className = 'file-loaded';
  el.innerHTML = `<span style="color:var(--green);font-size:18px;">‚úì</span><div><div class="fl-name">${name}</div><div class="fl-meta">${rows.toLocaleString()} rows loaded</div></div>`;
}

function checkRunReady() {
  const ready = state.convData && state.expData;
  document.getElementById('run-btn').disabled = !ready;
  document.getElementById('run-btn2').disabled = !ready;
  if (ready) {
    document.getElementById('run-bar-status').innerHTML = `<strong>${state.convData.length}</strong> conversions ¬∑ <strong>${state.expData.length}</strong> exposure records ready to match`;
  }
}

// ‚îÄ‚îÄ‚îÄ Sample Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadSampleData() {
  const companies = ['Acme Corp', 'Globex', 'Initech', 'Umbrella Co', 'Stark Industries', 'Wayne Enterprises', 'Pied Piper', 'Hooli', 'Dunder Mifflin', 'Bluth Company'];
  const geos = ['New York', 'San Francisco', 'Chicago', 'Austin', 'Boston', 'Seattle', 'Los Angeles'];
  const convTypes = ['Account/Opportunity', 'Lead Form Fill', 'Transaction'];
  const channels = ['LinkedIn', 'Google', 'Meta', 'Email', 'Organic'];
  const campaigns = {
    LinkedIn: ['Brand Awareness Q1', 'Retargeting - Decision Makers', 'Thought Leadership'],
    Google: ['Search - Brand', 'Search - Non-Brand', 'Display Retargeting'],
    Meta: ['Lookalike - Enterprise', 'Retargeting - Site Visitors'],
    Email: ['Nurture Series', 'Product Newsletter'],
    Organic: ['Direct / Organic'],
  };

  const convData = [];
  const baseDate = new Date('2024-01-01');
  for (let i = 0; i < 180; i++) {
    const d = new Date(baseDate.getTime() + Math.random() * 90 * 86400000);
    const co = companies[Math.floor(Math.random() * companies.length)];
    const geo = geos[Math.floor(Math.random() * geos.length)];
    const ct = convTypes[Math.floor(Math.random() * convTypes.length)];
    convData.push({
      timestamp: d.toISOString().split('T')[0],
      conversion_value: ct === 'Transaction' ? (Math.random() * 800 + 50).toFixed(2) : ct === 'Account/Opportunity' ? (Math.random() * 40000 + 5000).toFixed(2) : '0',
      conversion_type: ct,
      company_name: co,
      geo: geo,
      click_id: Math.random() > 0.65 ? 'gclid_' + Math.random().toString(36).substr(2, 8) : '',
    });
  }

  const expData = [];
  for (let i = 0; i < 600; i++) {
    const d = new Date(baseDate.getTime() + Math.random() * 90 * 86400000);
    const ch = channels[Math.floor(Math.random() * channels.length)];
    const co = Math.random() > 0.4 ? companies[Math.floor(Math.random() * companies.length)] : '';
    const geo = geos[Math.floor(Math.random() * geos.length)];
    const camp = campaigns[ch][Math.floor(Math.random() * campaigns[ch].length)];
    expData.push({
      timestamp: d.toISOString().split('T')[0],
      channel: ch,
      campaign: camp,
      company_name: co,
      geo: geo,
      click_id: Math.random() > 0.8 ? 'gclid_' + Math.random().toString(36).substr(2, 8) : '',
      impressions: Math.floor(Math.random() * 5000 + 100),
      spend: (Math.random() * 800 + 20).toFixed(2),
    });
  }

  state.convData = convData;
  state.expData = expData;
  showFileLoaded('conv', 'sample_conversions.csv', convData.length);
  showFileLoaded('exp', 'sample_exposure.csv', expData.length);
  checkRunReady();

  // Auto-run
  setTimeout(runAttribution, 200);
}

// ‚îÄ‚îÄ‚îÄ Attribution Engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runAttribution() {
  if (!state.convData || !state.expData) return;

  state.timeWindow = parseInt(document.getElementById('time-window').value) || 30;
  state.confThreshold = parseFloat(document.getElementById('conf-threshold').value) || 0.6;

  const windowMs = state.timeWindow * 86400000;
  const results = [];

  state.convData.forEach(conv => {
    const convTime = new Date(conv.timestamp).getTime();

    // Find candidate exposures within window
    const candidates = state.expData.filter(exp => {
      const expTime = new Date(exp.timestamp).getTime();
      return expTime <= convTime && convTime - expTime <= windowMs;
    });

    // Score each candidate
    const scored = candidates.map(exp => {
      let conf = 0;
      let method = 'geo+time';

      // Priority 1: Click ID match
      if (conv.click_id && exp.click_id && conv.click_id === exp.click_id) {
        conf = 1.0; method = 'click_id';
      }
      // Priority 2: Company name match
      else if (conv.company_name && exp.company_name) {
        const sim = strSimilarity(conv.company_name.toLowerCase(), exp.company_name.toLowerCase());
        if (sim > 0.8) { conf = 0.85 + sim * 0.1; method = 'company_name'; }
        else if (sim > 0.6 && conv.geo && exp.geo && conv.geo === exp.geo) { conf = 0.7; method = 'company+geo'; }
      }
      // Priority 3: Geo + time window
      else if (conv.geo && exp.geo && conv.geo === exp.geo) {
        const daysDiff = (convTime - new Date(exp.timestamp).getTime()) / 86400000;
        conf = Math.max(0.2, 0.5 - (daysDiff / state.timeWindow) * 0.3);
        method = 'geo+time';
      }

      return { ...exp, confidence: conf, match_method: method };
    }).filter(e => e.confidence >= state.confThreshold);

    if (scored.length === 0) {
      results.push({ ...conv, matched: false, channel: 'Unattributed', confidence: 0, match_method: 'none', attributed_value: parseFloat(conv.conversion_value) || 0 });
      return;
    }

    // Apply attribution model across touchpoints
    const totalConf = scored.reduce((s, e) => s + e.confidence, 0);
    scored.forEach(exp => {
      let weight = 0;
      if (state.model === 'linear') {
        weight = 1 / scored.length;
      } else if (state.model === 'last-touch') {
        const latest = scored.reduce((a, b) => new Date(a.timestamp) > new Date(b.timestamp) ? a : b);
        weight = exp === latest ? 1 : 0;
      } else if (state.model === 'first-touch') {
        const earliest = scored.reduce((a, b) => new Date(a.timestamp) < new Date(b.timestamp) ? a : b);
        weight = exp === earliest ? 1 : 0;
      } else if (state.model === 'time-decay') {
        const halfLife = 7 * 86400000;
        const decay = Math.exp(-Math.log(2) * (convTime - new Date(exp.timestamp).getTime()) / halfLife);
        const totalDecay = scored.reduce((s, e2) => s + Math.exp(-Math.log(2) * (convTime - new Date(e2.timestamp).getTime()) / halfLife), 0);
        weight = decay / totalDecay;
      }

      if (weight > 0) {
        results.push({
          ...conv,
          channel: exp.channel,
          campaign: exp.campaign || '‚Äî',
          matched: true,
          confidence: exp.confidence,
          match_method: exp.match_method,
          attributed_value: (parseFloat(conv.conversion_value) || 0) * weight,
          attributed_weight: weight,
          spend: parseFloat(exp.spend) || 0,
          exp_company: exp.company_name,
        });
      }
    });
  });

  state.results = results;
  renderDashboard();
  showPage('dashboard');
}

// Simple string similarity (Jaccard on bigrams)
function strSimilarity(a, b) {
  if (a === b) return 1;
  const bigrams = s => { const g = new Set(); for (let i = 0; i < s.length - 1; i++) g.add(s.slice(i, i+2)); return g; };
  const sa = bigrams(a), sb = bigrams(b);
  const inter = [...sa].filter(x => sb.has(x)).length;
  const union = new Set([...sa, ...sb]).size;
  return union === 0 ? 0 : inter / union;
}

// ‚îÄ‚îÄ‚îÄ Dashboard Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CHANNEL_COLORS = {
  LinkedIn: '#0a66c2', Google: '#4285f4', Meta: '#1877f2',
  Email: '#f5a623', Organic: '#34c78a', Unattributed: '#555e75',
};
const CHANNEL_COLORS_LIST = ['#4f7cff','#34c78a','#f5a623','#9b6dff','#2dd4bf','#f05c5c','#555e75'];

function renderDashboard() {
  const results = state.results;
  const matched = results.filter(r => r.matched);
  const totalConv = new Set(results.map(r => r.timestamp + r.company_name + r.conversion_value)).size;
  const matchedConv = new Set(matched.map(r => r.timestamp + r.company_name + r.conversion_value)).size;
  const totalRev = matched.reduce((s, r) => s + r.attributed_value, 0);
  const totalSpend = [...state.expData].reduce((s, e) => s + (parseFloat(e.spend) || 0), 0);

  // KPIs
  document.getElementById('kpi-conv').textContent = matchedConv;
  document.getElementById('kpi-match-rate').textContent = `${Math.round(matchedConv/totalConv*100)}% match rate`;
  document.getElementById('kpi-rev').textContent = '$' + totalRev.toLocaleString('en', { maximumFractionDigits: 0 });
  document.getElementById('kpi-spend').textContent = '$' + totalSpend.toLocaleString('en', { maximumFractionDigits: 0 });

  // Channel breakdown
  const byChannel = {};
  matched.forEach(r => {
    if (!byChannel[r.channel]) byChannel[r.channel] = { conv: 0, rev: 0, conf: [], campaigns: new Set() };
    byChannel[r.channel].conv++;
    byChannel[r.channel].rev += r.attributed_value;
    byChannel[r.channel].conf.push(r.confidence);
    byChannel[r.channel].campaigns.add(r.campaign);
  });

  const channelSpend = {};
  state.expData.forEach(e => {
    channelSpend[e.channel] = (channelSpend[e.channel] || 0) + (parseFloat(e.spend) || 0);
  });

  const sortedChannels = Object.entries(byChannel).sort((a,b) => b[1].rev - a[1].rev);
  const topChannel = sortedChannels[0];
  if (topChannel) {
    document.getElementById('kpi-top-channel').textContent = topChannel[0];
    document.getElementById('kpi-top-pct').textContent = Math.round(topChannel[1].rev / totalRev * 100) + '% of revenue';
  }

  const avgTouches = (matched.length / matchedConv).toFixed(1);
  document.getElementById('kpi-touches').textContent = avgTouches;

  const roas = totalSpend > 0 ? (totalRev / totalSpend).toFixed(1) + 'x ROAS' : '‚Äî';
  document.getElementById('kpi-roas').textContent = roas;

  document.getElementById('model-label').textContent = state.model.replace('-', ' ').replace(/\b\w/g, c => c.toUpperCase());
  document.getElementById('window-label').textContent = state.timeWindow;

  // Sidebar
  document.getElementById('sidebar-match').textContent = Math.round(matchedConv/totalConv*100) + '% matched';

  // Channel table
  const tbody = document.getElementById('channel-table-body');
  tbody.innerHTML = '';
  sortedChannels.forEach(([ch, d], i) => {
    const avgConf = d.conf.reduce((s,c)=>s+c,0)/d.conf.length;
    const spend = channelSpend[ch] || 0;
    const roas = spend > 0 ? (d.rev / spend).toFixed(1) + 'x' : '‚Äî';
    const color = CHANNEL_COLORS[ch] || CHANNEL_COLORS_LIST[i % CHANNEL_COLORS_LIST.length];
    tbody.innerHTML += `
      <tr>
        <td><span class="channel-dot" style="background:${color}"></span>${ch}</td>
        <td style="color:var(--text3);font-size:12px;">${[...d.campaigns].slice(0,2).join(', ')}</td>
        <td class="num">${d.conv}</td>
        <td class="num">$${d.rev.toLocaleString('en',{maximumFractionDigits:0})}</td>
        <td class="num">$${spend.toLocaleString('en',{maximumFractionDigits:0})}</td>
        <td class="num" style="color:${parseFloat(roas)>1?'var(--green)':'var(--red)'}">${roas}</td>
        <td>
          <div class="confidence-bar">
            <div class="conf-track"><div class="conf-fill" style="width:${avgConf*100}%;background:${color}"></div></div>
            <span style="font-family:var(--mono);font-size:11px;color:var(--text3);min-width:30px;">${Math.round(avgConf*100)}%</span>
          </div>
        </td>
      </tr>`;
  });

  // Charts
  renderBarChart(byChannel, CHANNEL_COLORS_LIST);
  renderPieChart(byChannel, CHANNEL_COLORS_LIST);
  renderTrendChart(matched);
  renderAccountTable(matched);
  renderMatchQuality(results, matchedConv, totalConv);
}

function destroyChart(id) { if (charts[id]) { charts[id].destroy(); delete charts[id]; } }

function renderBarChart(byChannel, colors) {
  destroyChart('channel-bar');
  const labels = Object.keys(byChannel);
  const ctx = document.getElementById('channel-bar-chart').getContext('2d');
  charts['channel-bar'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Attributed Revenue',
        data: labels.map(ch => byChannel[ch].rev),
        backgroundColor: labels.map((ch, i) => CHANNEL_COLORS[ch] || colors[i % colors.length]),
        borderRadius: 4,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: '#2a2f3f' }, ticks: { color: '#8b93a8' } },
        y: {
          grid: { color: '#2a2f3f' }, ticks: { color: '#8b93a8',
            callback: v => '$' + (v >= 1000 ? (v/1000).toFixed(0)+'k' : v)
          }
        }
      }
    }
  });
}

function renderPieChart(byChannel, colors) {
  destroyChart('channel-pie');
  const labels = Object.keys(byChannel);
  const ctx = document.getElementById('channel-pie-chart').getContext('2d');
  charts['channel-pie'] = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: labels.map(ch => byChannel[ch].rev),
        backgroundColor: labels.map((ch, i) => CHANNEL_COLORS[ch] || colors[i % colors.length]),
        borderWidth: 0,
        hoverOffset: 4,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '62%',
      plugins: { legend: { position: 'bottom', labels: { color: '#8b93a8', padding: 12, font: { size: 11 } } } }
    }
  });
}

function renderTrendChart(matched) {
  destroyChart('trend');
  const channels = [...new Set(matched.map(r => r.channel))];
  const dates = [...new Set(matched.map(r => r.timestamp.substr(0,7)))].sort();

  const ctx = document.getElementById('trend-chart').getContext('2d');
  charts['trend'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: channels.map((ch, i) => ({
        label: ch,
        data: dates.map(d => matched.filter(r => r.channel === ch && r.timestamp.startsWith(d)).length),
        borderColor: CHANNEL_COLORS[ch] || CHANNEL_COLORS_LIST[i % CHANNEL_COLORS_LIST.length],
        backgroundColor: 'transparent',
        tension: 0.4, pointRadius: 2,
      }))
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'top', labels: { color: '#8b93a8', font: { size: 11 }, boxWidth: 10 } } },
      scales: {
        x: { grid: { color: '#2a2f3f' }, ticks: { color: '#8b93a8' } },
        y: { grid: { color: '#2a2f3f' }, ticks: { color: '#8b93a8' } }
      }
    }
  });
}

function renderAccountTable(matched) {
  const acctRows = matched.filter(r => r.match_method !== 'geo+time' && r.company_name);
  const tbody = document.getElementById('account-table-body');
  tbody.innerHTML = '';
  const seen = new Set();
  acctRows.forEach(r => {
    const key = r.company_name + r.timestamp + r.channel;
    if (seen.has(key)) return; seen.add(key);
    const methodColors = { click_id: 'tag-green', company_name: 'tag-blue', 'company+geo': 'tag-purple', 'geo+time': 'tag-amber' };
    tbody.innerHTML += `
      <tr>
        <td style="font-weight:500;">${r.company_name || '‚Äî'}</td>
        <td style="color:var(--text3);">${r.geo || '‚Äî'}</td>
        <td>${r.conversion_type || '‚Äî'}</td>
        <td class="num">$${parseFloat(r.attributed_value).toLocaleString('en',{maximumFractionDigits:0})}</td>
        <td><span class="channel-dot" style="background:${CHANNEL_COLORS[r.channel]||'#4f7cff'}"></span>${r.channel}</td>
        <td><span class="tag ${methodColors[r.match_method]||'tag-amber'}">${r.match_method}</span></td>
        <td style="font-family:var(--mono);font-size:11px;">${Math.round(r.confidence*100)}%</td>
      </tr>`;
  });
  if (acctRows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text3);padding:24px;">No company-matched records found</td></tr>';
  }
}

function renderMatchQuality(results, matchedConv, totalConv) {
  const byMethod = {};
  results.filter(r => r.matched).forEach(r => {
    byMethod[r.match_method] = (byMethod[r.match_method] || 0) + 1;
  });

  destroyChart('match-method');
  const ctx = document.getElementById('match-method-chart').getContext('2d');
  const labels = Object.keys(byMethod);
  const methodColors = { click_id: '#34c78a', company_name: '#4f7cff', 'company+geo': '#9b6dff', 'geo+time': '#f5a623' };
  charts['match-method'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ data: Object.values(byMethod), backgroundColor: labels.map(l => methodColors[l] || '#555e75'), borderRadius: 4 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: '#2a2f3f' }, ticks: { color: '#8b93a8' } },
        y: { grid: { display: false }, ticks: { color: '#8b93a8' } }
      }
    }
  });

  const stats = document.getElementById('match-stats');
  const unmatched = results.filter(r => !r.matched).length;
  const clickMatched = results.filter(r => r.match_method === 'click_id').length;
  const compMatched = results.filter(r => r.match_method === 'company_name' || r.match_method === 'company+geo').length;
  const geoMatched = results.filter(r => r.match_method === 'geo+time').length;

  stats.innerHTML = `
    <div class="match-stat"><span class="match-label">Overall Match Rate</span><span class="match-value" style="color:var(--green)">${Math.round(matchedConv/totalConv*100)}%</span></div>
    <div class="match-stat"><span class="match-label">Click ID Matches (high conf.)</span><span class="match-value">${clickMatched}</span></div>
    <div class="match-stat"><span class="match-label">Company Name Matches (med.)</span><span class="match-value">${compMatched}</span></div>
    <div class="match-stat"><span class="match-label">Geo + Time Window (low conf.)</span><span class="match-value">${geoMatched}</span></div>
    <div class="match-stat"><span class="match-label">Unmatched / Unattributed</span><span class="match-value" style="color:var(--text3)">${unmatched}</span></div>
  `;
}

// ‚îÄ‚îÄ‚îÄ Explore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dragStart(e) {
  draggedField = { field: e.target.dataset.field, type: e.target.dataset.type };
}
function allowDrop(e) { e.preventDefault(); }
function dropAxis(e, axis) {
  e.preventDefault();
  if (!draggedField) return;
  if (axis === 'x' && draggedField.type !== 'dim') return;
  if (axis === 'y' && draggedField.type !== 'metric') return;

  if (axis === 'x') {
    exploreX = draggedField.field;
    document.getElementById('x-drop').classList.add('has-value');
    document.getElementById('x-drop-label').textContent = draggedField.field.replace(/_/g,' ');
    document.getElementById('x-drop-label').style.color = 'var(--text)';
  } else {
    exploreY = draggedField.field;
    document.getElementById('y-drop').classList.add('has-value');
    document.getElementById('y-drop-label').textContent = draggedField.field.replace(/_/g,' ');
    document.getElementById('y-drop-label').style.color = 'var(--text)';
  }

  if (exploreX && exploreY) renderExploreChart();
}

function renderExploreChart() {
  if (!exploreX || !exploreY || !state.results) {
    document.getElementById('explore-empty').style.display = 'block';
    document.getElementById('explore-chart-wrap').style.display = 'none';
    return;
  }

  const matched = state.results.filter(r => r.matched);
  const groups = {};

  matched.forEach(r => {
    const key = getField(r, exploreX) || 'Unknown';
    if (!groups[key]) groups[key] = { conv: 0, rev: 0, spend: 0 };
    groups[key].conv++;
    groups[key].rev += r.attributed_value;
    groups[key].spend += r.spend || 0;
  });

  // ROAS derived
  Object.keys(groups).forEach(k => {
    groups[k].roas = groups[k].spend > 0 ? groups[k].rev / groups[k].spend : 0;
    groups[k].attributed_conversions = groups[k].conv;
    groups[k].attributed_revenue = groups[k].rev;
  });

  const labels = Object.keys(groups);
  const data = labels.map(l => {
    const metricMap = {
      attributed_conversions: groups[l].conv,
      attributed_revenue: groups[l].rev,
      spend: groups[l].spend,
      roas: groups[l].roas,
    };
    return metricMap[exploreY] || 0;
  });

  destroyChart('explore');
  document.getElementById('explore-empty').style.display = 'none';
  document.getElementById('explore-chart-wrap').style.display = 'block';

  const xLabel = exploreX.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
  const yLabel = exploreY.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
  document.getElementById('explore-chart-title').textContent = `${yLabel} by ${xLabel}`;
  document.getElementById('explore-chart-sub').textContent = `${state.model.replace('-',' ')} model ¬∑ ${state.timeWindow}-day window`;

  const chartType = document.getElementById('chart-type').value;
  const ctx = document.getElementById('explore-canvas').getContext('2d');
  charts['explore'] = new Chart(ctx, {
    type: chartType,
    data: {
      labels,
      datasets: [{
        label: yLabel,
        data,
        backgroundColor: labels.map((l, i) => CHANNEL_COLORS[l] || CHANNEL_COLORS_LIST[i % CHANNEL_COLORS_LIST.length]),
        borderColor: chartType === 'line' ? '#4f7cff' : undefined,
        borderRadius: chartType === 'bar' ? 4 : 0,
        tension: 0.4,
        fill: false,
        borderWidth: chartType === 'doughnut' ? 0 : undefined,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: chartType === 'doughnut', position: 'bottom', labels: { color: '#8b93a8', font: { size: 11 } } }
      },
      scales: chartType !== 'doughnut' ? {
        x: { grid: { color: '#2a2f3f' }, ticks: { color: '#8b93a8' } },
        y: { grid: { color: '#2a2f3f' }, ticks: { color: '#8b93a8' } }
      } : {}
    }
  });
}

function getField(row, field) {
  const map = {
    channel: row.channel,
    campaign: row.campaign,
    conversion_type: row.conversion_type,
    geo: row.geo,
    company: row.company_name,
    match_method: row.match_method,
  };
  return map[field] || '';
}
</script>
</body>
</html>
